# SengenUI ライブラリ化 実装計画書

**作成日**: 2025年12月27日  
**現在の状況**: フォルダ移動完了、パッケージ化準備段階

---

## 1. 現状分析

### 1.1 SengenUI 内部構成

```
src/Packages/SengenUI/
├── SengenBase/           ← コア実装
│   ├── HtmlComponentBase.ts
│   ├── LV1HtmlComponentBase.ts
│   ├── LV2HtmlComponentBase.ts
│   ├── DomProxy.ts
│   ├── MathMLDomProxy.ts
│   ├── css長さ単位.ts
│   └── ...
├── Behaviors/            ← UI動作拡張
├── LV1UIComponents/      ← 基本UI要素
├── MathMLComponents/     ← 数式表示用
├── SvgUIComponents/      ← SVG描画
├── MouseAbstraction/     ← マウス入力（新規追加）
└── _文書/
```

**✅ 完了**: MouseAbstraction をパッケージ内に移動

### 1.2 外部依存関係（SengenUI から参照）

```
SengenUI
├── src/Extend/          ← ユーティリティ関数
│   ├── extend.ts        （ExtendFunction など）
│   ├── ExtendElement/
│   └── ...
├── src/Math/            ← 数学ライブラリ
│   ├── GrapgTheory/     （Vertex など）
│   └── LinearAlgebra/   （数と全単射な物 など）
└── src/MathMLLv2Components/  ← MathML v2 実装
    └── ILV2MathMLComponent
```

**参照例**:
- `SvgDomProxy.ts` → `../../../Extend/extend` + `../../../Math/GrapgTheory/graph`
- `css長さ単位.ts` → `../../../Math/LinearAlgebra/数と全単射な物`
- `HtmlComponentBase.ts` → `../../../MathMLLv2Components/ILV2MathMLComponent`

---

## 2. 戦略の選択肢

### ✅ 選択肢 A【推奨】: 現在の場所のままで、path mapping で依存解決

**特徴**:
- フォルダ移動は最小限
- SengenUI は `src/Packages/SengenUI/` のまま
- Extend、Math は `src/` 直下に残す
- ビルド時に `tsconfig.json` と `vite.config.ts` の `paths` で解決

**構造**:
```
app-ts/
  src/
    Packages/
      SengenUI/          ← UIライブラリ本体
        SengenBase/
        Behaviors/
        MouseAbstraction/
        ...
    Extend/            ← 共有ユーティリティ（SengenUI も使用）
    Math/              ← 共有数学ライブラリ（SengenUI も使用）
    MathMLLv2Components/  ← 共有コンポーネント
    AppPage/           ← Electron アプリ固有
    ...
  packages/
    ui-component/
      package.json     ← @voiro/ui-component
      vite.config.ts   ← alias で ../../../src/Extend など指定
      tsconfig.json    ← paths で ../../../src/Math など指定
```

**メリット**:
- ✅ フォルダ移動作業が少ない
- ✅ 他の部分から Extend や Math の参照パターンと一貫性がある
- ✅ 共有リソース（ExtendElement など）を複数パッケージで活用可能
- ✅ ビルド設定だけで対応できる

**デメリット**:
- ⚠️ npm publish 時に Extend と Math は別パッケージとして提供する必要がある
- ⚠️ SengenUI の依存関係が複雑に見える可能性

**実装方法**:

1. **tsconfig.json** (packages/ui-component/tsconfig.json):
```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@extend/*": ["../../src/Extend/*"],
      "@math/*": ["../../src/Math/*"],
      "@components/*": ["../../src/MathMLLv2Components/*"]
    }
  }
}
```

2. **vite.config.ts** (packages/ui-component/vite.config.ts):
```typescript
export default defineConfig({
  resolve: {
    alias: {
      '@extend': resolve(__dirname, '../../src/Extend'),
      '@math': resolve(__dirname, '../../src/Math'),
      '@components': resolve(__dirname, '../../src/MathMLLv2Components'),
    }
  }
});
```

3. **SengenUI 内のインポートを統一**:
```typescript
// 現在: ../../../Extend/extend
// 変更: @extend/extend

import { ExtendFunction } from '@extend/extend';
import { Vertex } from '@math/GrapgTheory/graph';
import { ILV2MathMLComponent } from '@components/ILV2MathMLComponent';
```

---

### 代替案 B: Extend と Math も Packages に移動（フル依存内部化）

**構造**:
```
app-ts/
  src/
    Packages/
      SengenUI/
      extend/           ← ユーティリティパッケージ化
      math/             ← 数学パッケージ化
      mathml-v2/        ← MathML パッケージ化
    AppPage/            ← Electron アプリのみ残す
    ...
```

**メリット**:
- ✅ 完全なモジュール分離
- ✅ 各パッケージが独立して npm publish 可能
- ✅ 依存関係が明確

**デメリット**:
- ⚠️ 大規模なフォルダ移動作業が必要
- ⚠️ 既存の他のコード（AppPage など）から Extend/Math を参照している場合、全て修正必要
- ⚠️ ビルド設定がより複雑に

**判断**: 現在は大規模な移動作業が多いため、**選択肢 A を推奨**

---

### 代替案 C: SengenUI の依存を最小化（MouseWife を分離）

**概要**: Extend や Math に依存する部分を SengenUI から除外

**該当機能**:
- `MouseWife.ts` → MouseAbstraction（既に移動完了）
- `SvgDomProxy.ts` → Extend + Math 依存
- `css長さ単位.ts` → Math 依存

**構造**:
```
Packages/
  SengenUI-core/   ← 純粋UI（依存最小）
  SengenUI-svg/    ← SVG描画（Math 依存）
  SengenUI-advanced/  ← 高度な機能
```

**メリット**:
- ✅ Pure UI ライブラリを提供可能
- ✅ 依存関係がシンプル

**デメリット**:
- ⚠️ API が複数に分かれて複雑化
- ⚠️ ユーザー側で複数パッケージを管理

**判断**: **非推奨**（開発効率が低下）

---

## 3. 実装計画【選択肢 A 採用】

### Phase 1: Path Mapping 設定（1-2日）

#### Step 1.1: 共有ライブラリの識別と分類

**Extend フォルダの役割別分類**:
```
Extend/
├── 【コア】extend.ts              ← DOM & JS 拡張
├── 【コア】ExtendElement/         ← DOM 要素操作
├── 【コア】ExtendEnum/            ← Enum ユーティリティ
├── 【UI補助】ExtendCss.ts         ← CSS 操作
├── 【アプリ特定】FileSystem/      ← ファイルシステム（アプリのみ）
├── 【アプリ特定】SpeechRecgnition/ ← 音声認識（アプリのみ）
└── 【共有】TimeExtend.ts, Global.ts など
```

**Math フォルダの役割別分類**:
```
Math/
├── 【コア】LinearAlgebra/    ← 数学基礎（SengenUI で使用）
├── 【UI補助】GrapgTheory/    ← グラフ構造（SVG 描画用）
└── 【アプリ特定】AppMath/ など
```

#### Step 1.2: packages/ui-component の設定更新

**ファイル一覧**:
- `packages/ui-component/tsconfig.json` — paths 定義
- `packages/ui-component/vite.config.ts` — alias 定義
- `packages/ui-component/package.json` — peerDependencies 追加（オプション）

#### Step 1.3: SengenUI 内のインポート パス統一

**対象ファイル**:
- `SengenBase/SvgDomProxy.ts`
- `SengenBase/css長さ単位.ts`
- その他 Extend/Math を参照しているファイル

**変換例**:
```typescript
// Before
import { ExtendFunction } from "../../../Extend/extend";
import { Vertex } from "../../../Math/GrapgTheory/graph";

// After
import { ExtendFunction } from "@extend/extend";
import { Vertex } from "@math/GrapgTheory/graph";
```

**ツール**: PowerShell 一括置換（既存テクニック使用）

---

### Phase 2: ビルド設定（1日）

#### Step 2.1: packages/ui-component/vite.config.ts 更新

```typescript
import { defineConfig } from 'vite';
import { resolve } from 'path';

export default defineConfig({
  build: {
    lib: {
      entry: resolve(__dirname, '../../src/Packages/SengenUI/index.ts'),
      name: 'SengenUI',
      formats: ['es', 'umd'],
      fileName: (format) => `sengen-ui.${format === 'umd' ? 'umd.js' : 'es.js'}`
    }
  },
  resolve: {
    alias: {
      '@extend': resolve(__dirname, '../../src/Extend'),
      '@math': resolve(__dirname, '../../src/Math'),
      '@mathml-v2': resolve(__dirname, '../../src/MathMLLv2Components'),
    }
  }
});
```

#### Step 2.2: packages/ui-component/tsconfig.json 更新

```json
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "../../src/Packages/SengenUI",
    "baseUrl": ".",
    "paths": {
      "@extend/*": ["../../src/Extend/*"],
      "@math/*": ["../../src/Math/*"],
      "@mathml-v2/*": ["../../src/MathMLLv2Components/*"],
      "@/*": ["../../src/Packages/SengenUI/*"]
    }
  },
  "include": ["../../src/Packages/SengenUI/**/*.ts"],
  "exclude": ["../../src/Packages/SengenUI/_文書/**/*"]
}
```

#### Step 2.3: app-ts ルート tsconfig.json で workspace の paths をマージ

```json
{
  "compilerOptions": {
    "baseUrl": "./src",
    "paths": {
      "@voiro/ui-component": ["./Packages/SengenUI/index.ts"],
      "@extend/*": ["./Extend/*"],
      "@math/*": ["./Math/*"],
      "@/*": ["/*"]
    }
  },
  "workspaces": [
    "packages/ui-component"
  ]
}
```

---

### Phase 3: エントリポイントと exports（1日）

#### Step 3.1: SengenUI エントリポイント作成

**src/Packages/SengenUI/index.ts** を作成:
```typescript
// Core Components
export * from './SengenBase/HtmlComponentBase';
export * from './SengenBase/LV1HtmlComponentBase';
export * from './SengenBase/LV2HtmlComponentBase';
export * from './SengenBase/DomProxy';
export * from './SengenBase/MathMLDomProxy';

// UI Components
export * from './LV1UIComponents';
export * from './MathMLComponents';
export * from './SvgUIComponents';
export * from './Behaviors';

// Mouse Input
export * from './MouseAbstraction';

// Types & Utils
export * from './SengenBase/css長さ単位';
export * from './SengenBase/HtmlComponentBaseInterfaces';
```

#### Step 3.2: packages/ui-component/package.json の exports 更新

```json
{
  "name": "@voiro/ui-component",
  "version": "0.1.0",
  "exports": {
    ".": {
      "import": "./dist/sengen-ui.es.js",
      "require": "./dist/sengen-ui.umd.js",
      "types": "./dist/index.d.ts"
    }
  },
  "files": ["dist"]
}
```

---

### Phase 4: 依存関係の明確化（1日）

#### Step 4.1: 外部依存を package.json に明記

```json
{
  "name": "@voiro/ui-component",
  "peerDependencies": {
    "@voiro/extend": "workspace:*",
    "@voiro/math": "workspace:*"
  },
  "devDependencies": {
    "typescript": "^5.7.3",
    "vite": "^5.4.8"
  }
}
```

#### Step 4.2: 依存グラフドキュメント作成

```
src/Packages/SengenUI/_文書/依存グラフ.md
```

内容:
- SengenUI が依存する各モジュール
- 各モジュール内での参照パターン
- 将来的なパッケージ分割案

---

### Phase 5: ビルド検証と npm publish 準備（1-2日）

#### Step 5.1: ローカルビルド検証

```bash
# packages/ui-component をビルド
npm run -w packages/ui-component build

# dist フォルダが生成されることを確認
ls -la packages/ui-component/dist
```

#### Step 5.2: npm publish シミュレーション

```bash
# ローカル npm registry でテスト（npm-quick-publish など）
npm run -w packages/ui-component pack
```

#### Step 5.3: 他のアプリから importing をテスト

Electron アプリ側:
```typescript
import { HtmlComponentBase, LV1HtmlComponentBase } from '@voiro/ui-component';
```

---

## 4. 段階的実装スケジュール

| フェーズ | 内容 | 期間 | 依存 |
|---------|------|------|------|
| Phase 1 | Path Mapping 設定 | 1-2日 | なし |
| Phase 2 | ビルド設定 | 1日 | Phase 1 |
| Phase 3 | エントリポイント | 1日 | Phase 1, 2 |
| Phase 4 | 依存関係明確化 | 1日 | Phase 1, 2, 3 |
| Phase 5 | ビルド検証 | 1-2日 | Phase 2, 3, 4 |

**合計**: 約 5-7日（段階的実装）

---

## 5. 今後の拡張戦略

### Extend / Math のパッケージ化（将来）

SengenUI のパッケージ化が完了後、必要に応じて以下を検討:

```
@voiro/extend      ← 汎用 JavaScript 拡張
@voiro/math        ← 汎用数学ライブラリ
@voiro/ui-component  ← SengenUI（@voiro/extend + @voiro/math に依存）
```

**トリガー**:
- 他の外部プロジェクトからの利用要望
- モジュールサイズが大きくなりすぎた場合

---

## 6. リスク管理

### R1: 相対パスの複雑性

**リスク**: `../../../src/Extend` の相対パスが多いと保守困難

**対策**:
- ✅ Path mapping (`@extend/`, `@math/` など) で統一
- ✅ VSCode の「Go to Definition」で自動解決

### R2: 循環依存

**リスク**: Extend や Math が SengenUI を逆参照しないか確認必要

**対策**:
- ✅ grep で循環参照をチェック
- ✅ 設計ドキュメント化

### R3: ビルド失敗

**リスク**: alias や paths の設定ミス

**対策**:
- ✅ ローカルビルドでテスト
- ✅ CI/CD パイプラインに追加

---

## 7. チェックリスト

- [ ] Extend / Math フォルダの役割を完全に把握
- [ ] packages/ui-component フォルダ作成
- [ ] tsconfig.json と vite.config.ts の path mapping 設定
- [ ] SengenUI 内のインポート文を統一
- [ ] エントリポイント (index.ts) 作成
- [ ] ローカルビルド実行
- [ ] dist フォルダが正しく生成されることを確認
- [ ] npm publish 準備完了

---

**次のアクション**: Phase 1 の Path Mapping 設定から開始
